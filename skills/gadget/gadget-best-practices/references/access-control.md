# Access Control

Gadget has a built-in RBAC system. All operations automatically enforce permissions.

## Key Principles

- All actions have permissions
- Permissions granted to roles
- Users assigned roles via `roleList` field
- No transitive/inherited permissions

## Roles

### Built-In Roles

**unauthenticated** - Public access
**signed-in** - Authenticated users
**system-admin** - Super user (never grant explicitly - has all permissions)

### Custom Roles

Create in **Settings → Roles** (e.g., `editor`, `admin`, `viewer`)

### User Roles

```javascript
await api.user.update("user-id", {
  roleList: ["signed-in", "editor"]
});
```

## Configuring Permissions

Permissions are configured in `accessControl/permissions.gadget.ts`. This file is auto-generated by Gadget based on your role and permission settings in the IDE, but you can also edit it directly.

The file structure uses roles as the top-level keys, with permissions defined per model:

```typescript
import type { GadgetAccessControl } from "gadget-server";

export const accessControl: GadgetAccessControl = {
  type: "gadget/access-control/v1",
  roles: {
    "signed-in": {
      storageKey: "signed-in",
      models: {
        post: {
          read: true,  // Grant read permission
          actions: {
            create: true,
            update: true,
            delete: false
          }
        }
      }
    }
  }
};
```

## Permission Filters

Use Gelly filter snippets to limit access to record subsets. Filters are stored as separate `.gelly` files and referenced by path:

### Common Patterns

**World Readable (no filter):**
```typescript
models: {
  post: {
    read: true  // All records visible
  }
}
```

**User-Scoped (own records only):**
Create `accessControl/filters/post/tenant.gelly`:
```gelly
filter ($session: Session) on Post [
  where userId == $session.userId
]
```

Then reference in permissions:
```typescript
models: {
  post: {
    read: { filter: "accessControl/filters/post/tenant.gelly" }
  }
}
```

**Shop-Scoped (multi-tenant):**
Create `accessControl/filters/product/shop-tenant.gelly`:
```gelly
filter ($session: Session) on Product [
  where shopId == $session.shopId
]
```

Reference in permissions:
```typescript
models: {
  product: {
    read: { filter: "accessControl/filters/product/shop-tenant.gelly" }
  }
}
```

**Status-based:**
Create `accessControl/filters/post/published.gelly`:
```gelly
filter ($session: Session) on Post [
  where status == 'published' OR userId == $session.userId
]
```

## Multi-Tenancy

Every multi-tenant model needs:

1. **`belongsTo` to tenancy model** (e.g., `shop`, `organization`, `user`)
2. Gelly **permission filter** on that field

```javascript
model product {
  belongsTo shop: ShopifyShop
}
```

```typescript
// In permissions.gadget.ts
roles: {
  "shopify-app-users": {
    storageKey: "shopify-app-users",
    models: {
      product: {
        read: { filter: "accessControl/filters/product/shop-tenant.gelly" }
      }
    }
  }
}
```

**CRITICAL:** No transitive permissions - add filters to EVERY model.

### Denormalized Tenancy

Prefer direct relationships over traversing:

✅ **Good:**
```javascript
model comment {
  belongsTo shop: ShopifyShop  // Direct
}
```

```gelly
filter shopId == $tenant.id
```

❌ **Avoid:**
```javascript
model comment {
  belongsTo post: Post  // Indirect
}
```

```gelly
filter post.shopId == $tenant.id  // Slower
```

## Internal API

Bypasses permissions, validations, and action lifecycle. Actions are not run when using the internal API.

✅ **Use only when direct database updates are needed** (in backend code - actions, routes):
```javascript
const allPosts = await api.internal.post.findMany();
```

❌ **NOT available in frontend** - The internal API does not exist in the frontend and cannot be called from frontend code

⚠️ **Important:** The internal API bypasses the action lifecycle (`run`, `onSuccess`, etc.). Use regular API calls (`api.post.create()`) if you need actions to execute.

## Example: Blog App

```typescript
import type { GadgetAccessControl } from "gadget-server";

export const accessControl: GadgetAccessControl = {
  type: "gadget/access-control/v1",
  roles: {
    unauthenticated: {
      storageKey: "unauthenticated",
      models: {
        user: {
          actions: {
            signUp: true,  // Allow sign up
            signIn: true
          }
        },
        post: {
          read: { filter: "accessControl/filters/post/published.gelly" }
        }
      }
    },
    "signed-in": {
      storageKey: "signed-in",
      models: {
        user: {
          read: { filter: "accessControl/filters/user/tenant.gelly" },
          actions: {
            update: { filter: "accessControl/filters/user/tenant.gelly" },
            signOut: { filter: "accessControl/filters/user/tenant.gelly" }
          }
        },
        post: {
          read: { filter: "accessControl/filters/post/user-or-published.gelly" },
          actions: {
            create: true,
            update: { filter: "accessControl/filters/post/author.gelly" }
          }
        }
      }
    },
    admin: {
      storageKey: "admin",
      models: {
        post: {
          read: true,
          actions: {
            delete: true
          }
        }
      }
    }
  }
};
```

## Best Practices

**DO:**
- ✅ Grant permissions explicitly to each role
- ✅ Add filters for multi-tenant models
- ✅ Use denormalized tenancy (direct relationships)
- ✅ Test with different roles
- ✅ Check routes manually (not auto-enforced)

**DON'T:**
- ❌ Grant explicit permissions to `system-admin`
- ❌ Assume transitive permissions
- ❌ Try to use internal API from frontend (it doesn't exist there)
- ❌ Delete/rename built-in roles or `session` model

## Common Mistakes

1. **Missing tenancy filters** - Data leaks
2. **Assuming transitive permissions** - Each model needs its own filter
3. **Traversing relationships** - Prefer direct
4. **Trying to use internal API from frontend** - It doesn't exist in the frontend

## See Also

- [shopify-multi-tenancy.md](shopify-multi-tenancy.md) - Shop isolation
- [actions.md](actions.md) - How actions enforce permissions
- [Gelly docs](https://docs.gadget.dev/reference/gelly) - Filter syntax
